var spawn = require('child_process').spawn;

module.exports = function(repo, targetPath, opts, cb) {

    if (typeof opts === 'function') {
        cb = opts;
        opts = null;
    }

    opts = opts || {};

    var git = opts.git || 'git';
    var args = ['clone'];

    if (opts.shallow) {
        args.push('--depth');
        args.push('1');
    }

    args.push('--progress')
    
    args.push('--');
    args.push(repo);
    args.push(targetPath);

    var process = spawn(git, args);
    process.stdout.on("data", (chunk) => {
        let procStdOutDataMsg = "child_process(" + process.pid + ")::clone("+ repo +"):stdout:data: " + chunk;
        console.log();
    });
    process.stdout.on("error", (error) => {
        let procStdOutErrMsg = "child_process(" + process.pid + ")::clone("+ repo +"):stdout:error: " + error;
        console.log();
    });
    process.stderr.on("data", (chunk) => {
        let procStdErrDataMsg = "child_process(" + process.pid + ")::clone("+ repo +"):stderr:data: " + chunk;
        console.log();
    });
    process.stderr.on("error", (error) => {
        let procStdErrErrMsg = "child_process(" + process.pid + ")::clone("+ repo +"):stderr:error: " + error;
        console.log();
    });



    process.on('close', function(status) {
        if (status == 0) {
            if (opts.checkout) {
                _checkout();
            } else {
                cb && cb();    
            }
        } else {
            let errorMessage = "child_process(" + process.pid + ")::clone("+ repo +"):close():error: " + error + ", with status: " + status;
            console.log(errorMessage);
            let error = new Error(errorMessage);
            cb && cb(error);
        }
    });

    function _checkout() {
        var args = ['checkout', opts.checkout];
        var process = spawn(git, args, { cwd: targetPath });
        process.stdout.on("data", (chunk) => {
            console.log("cp::checkout("+ repo +"):stdout:data: " + chunk);
        });
        process.stdout.on("error", (error) => {
            console.log("cp::checkout("+ repo +"):stdout:error: " + error);
        });
    
        process.stderr.on("data", (chunk) => {
            console.log("cp::checkout("+ repo +"):stderr:data: " + chunk);
        });
        process.stderr.on("error", (error) => {
            console.log("cp::checkout("+ repo +"):stderr:error: " + error);
        });
    
        process.on('close', function(status) {
            if (status == 0) {
                cb && cb();
            } else {
                cb && cb(new Error("'git checkout' failed for repository: " + repo + " with status " + status));
            }
        });
    }

}
